<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>ç‰©åƒ¹ç­†è¨˜æœ¬(æ¢ç¢¼ç‰ˆ)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary-color: #5D737E;
            --bg-color: #F2F0EB;
            --accent-color: #A63D40;
            --low-price-color: #27AE60;
            --text-main: #3E3E3E;
            --text-sub: #8C8C8C;
            --card-bg: #FFFFFF;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; }

        .input-card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 15px; position: relative; }
        .form-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .form-group { flex: 1; min-width: 0; position: relative; }
        label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 4px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #CCC; border-radius: 6px; font-size: 1rem; }
        
        /* æ¢ç¢¼è¼¸å…¥å€å¡Šæ¨£å¼ */
        .barcode-group { display: flex; gap: 5px; }
        .barcode-group input { border-radius: 6px 0 0 6px; border-right: none; }
        .btn-scan { width: 50px; border-radius: 0 6px 6px 0; border: 1px solid #CCC; background: #EEE; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; padding: 0; }
        
        .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #DDD; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 0 0 8px 8px; }
        .autocomplete-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #F0F0F0; }

        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-add { background-color: var(--primary-color); color: white; margin-top: 5px; }
        
        .storage-tools { display: flex; gap: 8px; margin-top: 10px; }
        .btn-tool { background-color: #E0E0E0; font-size: 0.8rem; padding: 8px; flex: 1; color: var(--text-main); }

        .search-box { margin-bottom: 15px; }
        .search-box input { border: 2px solid var(--primary-color); border-radius: 25px; padding-left: 15px; }

        /* å¡ç‰‡èˆ‡åˆ—è¡¨ */
        .item-card { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 12px; border-top: 4px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; flex-wrap: wrap;}
        .item-title-group { flex: 1; }
        .item-name { font-weight: bold; font-size: 1.2rem; display: block;}
        .item-barcode { font-size: 0.8rem; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-flex; align-items: center; gap: 5px;}
        
        .btn-action-sm { font-size: 0.7rem; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 2px 6px; border-radius: 4px; cursor: pointer; background: none; width: auto; font-weight: normal; margin-left: 5px; }
        .header-actions { display: flex; gap: 5px; }

        .all-time-low { display: inline-block; background: #E8F5E9; color: var(--low-price-color); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; margin-bottom: 10px; margin-top: 5px; }
        
        .history-list { border-top: 1px solid #EEE; padding-top: 10px; }
        .history-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #F0F0F0; }
        .history-row:last-child { border-bottom: none; }
        
        .history-info { flex: 1; }
        .history-meta { color: var(--text-sub); font-size: 0.75rem; margin-bottom: 2px; }
        .store-label { background: #EEE; padding: 1px 4px; border-radius: 3px; margin-right: 4px; color: var(--text-main); }
        .note-text { color: var(--accent-color); font-size: 0.75rem; font-style: italic; }
        
        .history-price-actions { text-align: right; min-width: 100px; }
        .history-price { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
        .low-badge { color: white; background: var(--low-price-color); padding: 1px 4px; border-radius: 3px; font-size: 0.65rem; margin-left: 5px; }

        .action-links { font-size: 0.7rem; color: #0066CC; text-decoration: underline; cursor: pointer; }
        .btn-del-link { color: #999; margin-left: 8px; }

        /* æƒæå™¨ Modal */
        #scanner-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #reader { width: 100%; max-width: 500px; }
        .scan-close-btn { margin-top: 20px; padding: 10px 30px; background: white; color: black; border-radius: 20px; width: auto; }
        .scan-instruction { color: white; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="scanner-modal">
    <div class="scan-instruction">è«‹å°‡æ¢ç¢¼å°æº–æ¡†æ¡†</div>
    <div id="reader"></div>
    <button class="scan-close-btn" onclick="stopScanner()">âŒ é—œé–‰æƒæ</button>
</div>

<div class="container">
    <h3 style="text-align:center;">ğŸ“¦ ç‰©åƒ¹ç­†è¨˜æœ¬ v1.0</h3>

    <div class="input-card">
        <div class="form-row">
            <div class="form-group" style="flex: 0.7;"><label>åœ°é»</label><select id="store"><option>å…¨è¯</option><option>å®¶æ¨‚ç¦</option><option>å…¨å®¶</option><option>7-11</option><option>å¥½å¸‚å¤š</option><option>å…¶ä»–</option></select></div>
            <div class="form-group">
                <label>æ¢ç¢¼ (å¯é¸)</label>
                <div class="barcode-group">
                    <input type="text" id="barcodeInput" placeholder="æƒææˆ–è¼¸å…¥" oninput="checkBarcode(this.value)">
                    <button class="btn-scan" onclick="startScanner('new')">ğŸ“·</button>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>ç‰©å“åç¨±</label><input type="text" id="itemName" placeholder="ç¾©ç¾ç¶“å…¸åŸå‘³å¥¶èŒ¶18g18åŒ…" autocomplete="off" oninput="showSuggestions(this.value)"><div id="suggestionList" class="autocomplete-list" style="display:none;"></div></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>å–®åƒ¹</label><input type="number" id="price" inputmode="decimal"></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="note" placeholder="è²·äºŒé€ä¸€"></div>
        </div>
        <button class="btn-add" onclick="addItem()">âš¡ è¨˜éŒ„åƒ¹æ ¼</button>
        <div class="storage-tools">
            <button class="btn-tool" onclick="exportJSON()">ğŸ“¤ å‚™ä»½</button>
            <button class="btn-tool" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importJSON(event)">
        </div>
    </div>

    <div class="search-box"><input type="text" id="searchInput" oninput="renderList()" placeholder="ğŸ” æœå°‹å•†å“æˆ–æ¢ç¢¼..."></div>
    <div id="itemList"></div>
</div>

<script>
    // è³‡æ–™çµæ§‹æ–°å¢ barcode æ¬„ä½
    let products = JSON.parse(localStorage.getItem('price_master_v11')) || [];
    // ç°¡å–®çš„è³‡æ–™é·ç§»ï¼šå¦‚æœèˆŠè³‡æ–™æ²’æœ‰ barcode æ¬„ä½ï¼Œç¢ºä¿ä¹‹å¾Œå­˜å–ä¸æœƒå‡ºéŒ¯
    
    let html5QrcodeScanner = null;
    let scanMode = 'new'; // 'new' or 'edit'
    let editingProductId = null;

    renderList();

    // --- æƒæç›¸é—œé‚è¼¯ ---

    function startScanner(mode, prodId = null) {
        scanMode = mode;
        editingProductId = prodId;
        document.getElementById('scanner-modal').style.display = 'flex';
        
        // ç¢ºä¿ DOM å·²ç¶“é¡¯ç¤ºå¾Œå†å•Ÿå‹•
        setTimeout(() => {
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            
            // å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­ environment
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™ (HTTPS required)ã€‚\néŒ¯èª¤: " + err);
                stopScanner();
            });
        }, 100);
    }

    function stopScanner() {
        document.getElementById('scanner-modal').style.display = 'none';
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
            }).catch(err => console.error(err));
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        stopScanner();
        // æ’­æ”¾æç¤ºéŸ³ (å¯é¸)
        // let audio = new Audio('beep.mp3'); audio.play(); 

        if (scanMode === 'new') {
            // æ–°å¢æ¨¡å¼
            document.getElementById('barcodeInput').value = decodedText;
            checkBarcode(decodedText); // è§¸ç™¼è‡ªå‹•å¡«å…¥
        } else if (scanMode === 'edit' && editingProductId) {
            // ä¿®æ”¹æ¨¡å¼
            updateProductBarcode(editingProductId, decodedText);
        }
    }

    // æª¢æŸ¥æ¢ç¢¼æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«
    function checkBarcode(code) {
        if (!code) return;
        const existProd = products.find(p => p.barcode === code);
        if (existProd) {
            // å¦‚æœæ‰¾åˆ°ï¼Œè‡ªå‹•å¸¶å…¥åç¨±
            document.getElementById('itemName').value = existProd.name;
            // è¦–è¦ºæç¤º
            document.getElementById('itemName').style.backgroundColor = "#E8F5E9";
            setTimeout(() => document.getElementById('itemName').style.backgroundColor = "white", 1000);
            
            // å¯ä»¥é¸æ“‡èšç„¦åˆ°åƒ¹æ ¼æ¬„ä½
            document.getElementById('price').focus();
        }
    }

    // ä¿®æ”¹ç‰¹å®šå•†å“çš„æ¢ç¢¼
    function updateProductBarcode(id, code) {
        let prod = products.find(p => p.id === id);
        
        // æª¢æŸ¥æ¢ç¢¼æ˜¯å¦è¢«å…¶ä»–å•†å“ä½¿ç”¨
        const duplicate = products.find(p => p.barcode === code && p.id !== id);
        if (duplicate) {
            if(!confirm(`æ¢ç¢¼ ${code} å·²è¢«ã€Œ${duplicate.name}ã€ä½¿ç”¨ã€‚\nç¢ºå®šè¦å°‡æ­¤æ¢ç¢¼è½‰ç§»çµ¦ã€Œ${prod.name}ã€å—ï¼Ÿ`)) {
                return;
            }
            // æ¸…é™¤å¦ä¸€å€‹å•†å“çš„æ¢ç¢¼ä»¥å…é‡è¤‡ (è¦–éœ€æ±‚è€Œå®šï¼Œé€šå¸¸æ¢ç¢¼æ‡‰å”¯ä¸€)
            duplicate.barcode = ""; 
        }

        prod.barcode = code;
        saveAndRender();
        alert(`å·²æ›´æ–°ã€Œ${prod.name}ã€çš„æ¢ç¢¼ç‚ºï¼š${code}`);
    }


    // --- åŸæœ‰é‚è¼¯ä¿®æ”¹ ---

    function renameProduct(id) {
        let prod = products.find(p => p.id === id);
        const newName = prompt(`å°‡ã€Œ${prod.name}ã€ä¿®æ”¹ç‚ºæ–°çš„å“å:`, prod.name);
        if (newName && newName.trim() !== "" && newName !== prod.name) {
            const duplicate = products.find(p => p.name === newName.trim());
            if (duplicate) {
                if (confirm(`å·²æœ‰ã€Œ${newName.trim()}ã€çš„ç´€éŒ„ï¼Œæ˜¯å¦å°‡å…©è€…åˆä½µï¼Ÿ`)) {
                    duplicate.history = [...duplicate.history, ...prod.history];
                    // åˆä½µæ™‚ï¼Œå¦‚æœèˆŠçš„æœ‰æ¢ç¢¼ï¼Œæ–°çš„æ²’æœ‰ï¼Œå‰‡ä¿ç•™èˆŠçš„æ¢ç¢¼
                    if (!duplicate.barcode && prod.barcode) duplicate.barcode = prod.barcode;
                    products = products.filter(p => p.id !== id);
                } else { return; }
            } else {
                prod.name = newName.trim();
            }
            saveAndRender();
        }
    }

    function showSuggestions(val) {
        const list = document.getElementById('suggestionList');
        if (!val) { list.style.display = 'none'; return; }
        // æœå°‹åç¨±
        const matches = products.filter(p => p.name.includes(val)).map(p => p.name).slice(0, 5);
        if (matches.length > 0) {
            list.innerHTML = matches.map(m => `<div class="autocomplete-item" onclick="selectSuggestion('${m}')">${m}</div>`).join('');
            list.style.display = 'block';
        } else { list.style.display = 'none'; }
    }

    function selectSuggestion(name) {
        document.getElementById('itemName').value = name;
        document.getElementById('suggestionList').style.display = 'none';
        
        // è‡ªå‹•å¸¶å…¥è©²å•†å“çš„æ¢ç¢¼ (å¦‚æœæœ‰)
        const prod = products.find(p => p.name === name);
        if (prod && prod.barcode) {
            document.getElementById('barcodeInput').value = prod.barcode;
        }

        document.getElementById('price').focus();
    }

    function addItem() {
        const store = document.getElementById('store').value;
        const name = document.getElementById('itemName').value.trim();
        const price = parseFloat(document.getElementById('price').value);
        const note = document.getElementById('note').value.trim();
        const barcode = document.getElementById('barcodeInput').value.trim(); // å–å¾—æ¢ç¢¼
        const date = new Date().toLocaleDateString('zh-TW');

        if (!name || isNaN(price)) return alert('è«‹è¼¸å…¥åç¨±èˆ‡åƒ¹æ ¼');
        
        // å„ªå…ˆç”¨æ¢ç¢¼æ‰¾ï¼Œå†ç”¨åç¨±æ‰¾
        let prod = products.find(p => (barcode && p.barcode === barcode) || p.name === name);

        const newRecord = { id: Date.now(), date, store, price, note };

        if (prod) {
            // å¦‚æœæ˜¯ç”¨åç¨±æ‰¾åˆ°çš„ï¼Œä½†ç¾åœ¨è¼¸å…¥äº†æ–°æ¢ç¢¼ä¸”åŸæœ¬æ²’æœ‰æ¢ç¢¼ï¼Œå‰‡è£œä¸Š
            if (barcode && !prod.barcode) {
                prod.barcode = barcode;
            }
            // å¦‚æœåç¨±è®Šäº†ä½†æ¢ç¢¼ä¸€æ¨£ (å¯èƒ½æ˜¯ä½¿ç”¨è€…æƒ³ä¿®æ­£åç¨±)ï¼Œé€™è£¡å…ˆä¿æŒåŸåï¼Œç”¨ rename åŠŸèƒ½ä¿®æ”¹è¼ƒå®‰å…¨
            
            prod.history.unshift(newRecord);
        } else { 
            // å®Œå…¨æ–°å•†å“
            products.unshift({ 
                id: Date.now(), 
                name, 
                barcode: barcode, // å„²å­˜æ¢ç¢¼
                history: [newRecord] 
            }); 
        }
        
        saveAndRender();
        // æ¸…ç©ºæ¬„ä½
        document.getElementById('itemName').value = '';
        document.getElementById('price').value = '';
        document.getElementById('note').value = '';
        document.getElementById('barcodeInput').value = '';
    }

    function editRecord(prodId, recordId) {
        let prod = products.find(p => p.id === prodId);
        let rec = prod.history.find(r => r.id === recordId);
        const newPrice = prompt(`ä¿®æ”¹åƒ¹æ ¼:`, rec.price);
        if (newPrice !== null && !isNaN(parseFloat(newPrice))) {
            const newNote = prompt(`ä¿®æ”¹å‚™è¨»:`, rec.note);
            rec.price = parseFloat(newPrice);
            if (newNote !== null) rec.note = newNote;
            saveAndRender();
        }
    }

    function deleteRecord(prodId, recordId) {
        if(confirm('ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ')) {
            let prod = products.find(p => p.id === prodId);
            prod.history = prod.history.filter(r => r.id !== recordId);
            if(prod.history.length === 0) products = products.filter(p => p.id !== prodId);
            saveAndRender();
        }
    }

    function saveAndRender() {
        // æ›´æ–°ç‰ˆæœ¬è™Ÿä»¥å…æ··æ·†
        localStorage.setItem('price_master_v11', JSON.stringify(products));
        renderList();
    }

    function renderList() {
        const listDiv = document.getElementById('itemList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        // æœå°‹é‚è¼¯ï¼šåŒæ™‚æœå°‹åç¨±èˆ‡æ¢ç¢¼
        const filtered = products.filter(p => 
            p.name.toLowerCase().includes(search) || 
            (p.barcode && p.barcode.includes(search))
        );

        listDiv.innerHTML = filtered.map(p => {
            const minPrice = Math.min(...p.history.map(h => h.price));
            return `
                <div class="item-card">
                    <div class="item-header">
                        <div class="item-title-group">
                            <span class="item-name">${p.name}</span>
                            ${p.barcode ? `<span class="item-barcode">ğŸ“Š ${p.barcode} <button class="btn-action-sm" onclick="startScanner('edit', ${p.id})">ä¿®æ”¹</button></span>` : 
                                         `<button class="btn-action-sm" onclick="startScanner('edit', ${p.id})">â• ç¶å®šæ¢ç¢¼</button>`}
                        </div>
                        <div class="header-actions">
                            <button class="btn-action-sm" onclick="renameProduct(${p.id})">é‡å‘½å</button>
                        </div>
                    </div>
                    <div class="all-time-low">ğŸ’ æ­·å²æœ€ä½åƒ¹ï¼š$${minPrice}</div>
                    <div class="history-list">
                        ${p.history.map(h => `
                            <div class="history-row">
                                <div class="history-info">
                                    <div class="history-meta"><span class="store-label">${h.store}</span>${h.date}</div>
                                    ${h.note ? `<div class="note-text">è¨»: ${h.note}</div>` : ''}
                                </div>
                                <div class="history-price-actions">
                                    <div class="history-price">$${h.price}${h.price === minPrice ? '<span class="low-badge">ğŸ”¥ å²ä½</span>' : ''}</div>
                                    <span class="action-links" onclick="editRecord(${p.id}, ${h.id})">ä¿®æ”¹</span>
                                    <span class="action-links btn-del-link" onclick="deleteRecord(${p.id}, ${h.id})">åˆªé™¤</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(products, null, 2)], { type: "application/json" });
        const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: `åƒ¹æ ¼ç´€éŒ„_v11.json` });
        a.click();
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try { products = JSON.parse(e.target.result); saveAndRender(); alert('åŒ¯å…¥æˆåŠŸ'); }
            catch (err) { alert('æª”æ¡ˆæ ¼å¼ä¸ç›¸å®¹'); }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
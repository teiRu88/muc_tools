<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èé æ¸¬ç‹ v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #333;
            --bg: #F2F0EB;
            --accent: #ff9500;
        }

        body {
            font-family: -apple-system, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            color: var(--primary);
        }

        h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .user-info {
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bet-zone {
            border: 2px solid var(--accent);
        }

        .bet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .bet-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .bet-buttons button:active {
            transform: scale(0.95);
        }

        textarea {
            width: 100%;
            height: 70px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            font-size: 16px;
            margin-top: 10px;
        }

        .btn-send {
            width: 100%;
            padding: 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        #board {
            margin-top: 20px;
        }

        .post {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 8px;
            font-weight: bold;
            color: white;
        }

        .tag-up {
            background: #e74c3c;
        }

        .tag-down {
            background: #27ae60;
        }

        .btn-restore {
            background: #555;
            border: none;
            color: #ccc;
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-restore:hover {
            color: white;
        }
    </style>
</head>

<body>

    <h2>ğŸ”¥ é æ¸¬è¨è«–å€ <span id="status" style="font-size:12px; color: gray;">â— é€£ç·šä¸­</span></h2>

    <div class="card user-info">
        <span>ğŸ’° ç±Œç¢¼: <b id="balance">---</b></span>
        <span>
            <small id="code-display" style="margin-right:10px;">ä»£ç¢¼: ---</small>
            <button class="btn-restore" onclick="restoreAccount()">æ‰¾å›å¸³è™Ÿ</button>
        </span>
    </div>

    <div class="card bet-zone">
        <strong>ä»Šæ—¥é¡Œç›®ï¼šé»ƒé‡‘åƒ¹æ ¼ä»Šæ™šæœƒæ¼²ç ´ $2700 å—ï¼Ÿ</strong>
        <div class="bet-buttons">
            <button onclick="placeBet('çœ‹æ¼²')" style="background:#e74c3c">æŠ¼ã€Œæ¼²ã€ (100)</button>
            <button onclick="placeBet('çœ‹è·Œ')" style="background:#27ae60">æŠ¼ã€Œè·Œã€ (100)</button>
        </div>
    </div>

    <div class="card">
        <textarea id="msg" placeholder="èªªé»ä»€éº¼... (ä¸‹æ³¨å¾Œç™¼æ–‡æœƒè‡ªå‹•å¸¶æ¨™ç±¤)"></textarea>
        <button class="btn-send" onclick="send()">é€å‡ºç•™è¨€</button>
    </div>

    <div id="board">è¼‰å…¥ä¸­...</div>

    <script>
        // --- è¨­å®šå€ ---
        const SUPABASE_URL = 'https://bwkwhieercycwlwhuhml.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_t0WbG_SCuMwWMQBDMlsOEg_vtNXV_Fq';
        const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // å…¨åŸŸè®Šæ•¸
        let myProfile = { id: null, balance: 0, lastBet: "", backup_code: "" };

        // --- 2. åˆå§‹åŒ–åŠŸèƒ½ ---
        async function init() {
            const statusEl = document.getElementById('status');
            try {
                // A. åŒ¿åç™»å…¥
                const { data: auth, error: aErr } = await _db.auth.signInAnonymously();
                if (aErr) throw aErr;

                // B. å„ªå…ˆå¾æœ¬åœ°è¨˜æ†¶è®€å–ä»£ç¢¼
                const savedCode = localStorage.getItem('my_backup_code');
                let data = null;

                if (savedCode) {
                    const { data: oldData } = await _db.from('ei-players').select('*').eq('backup_code', savedCode).maybeSingle();
                    data = oldData;
                }

                // C. è‹¥ç„¡ä»£ç¢¼æˆ–ä»£ç¢¼å¤±æ•ˆï¼Œç”¨ Auth ID æ‰¾
                if (!data) {
                    const { data: authData } = await _db.from('ei-players').select('*').eq('id', auth.user.id).maybeSingle();
                    data = authData;
                }

                // D. çœŸçš„æ˜¯æ–°ç©å®¶ï¼Œå‰‡å»ºç«‹æ–°è³‡æ–™
                if (!data) {
                    const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    const { data: newData, error: iErr } = await _db.from('ei-players')
                        .insert([{ id: auth.user.id, balance: 1000, backup_code: newCode }])
                        .select().single();
                    if (iErr) throw iErr;
                    data = newData;
                }

                // E. åŒæ­¥åˆ°å…¨åŸŸèˆ‡ UI
                myProfile.id = data.id;
                myProfile.balance = data.balance;
                myProfile.backup_code = data.backup_code;
                localStorage.setItem('my_backup_code', data.backup_code);

                renderUI();
                loadBoard();

                statusEl.innerText = "â— åœ¨ç·š";
                statusEl.style.color = "green";
            } catch (err) {
                console.error("Init Error:", err);
                statusEl.innerText = "â— é€£ç·šå¤±æ•—";
                statusEl.style.color = "red";
            }
        }

        // --- 3. åŠŸèƒ½å‡½å¼ ---

        function renderUI() {
            document.getElementById('balance').innerText = myProfile.balance;
            document.getElementById('code-display').innerText = "ä»£ç¢¼: " + myProfile.backup_code;
        }

        // å¦‚æœä»Šå¤©ä¸‹æ³¨éï¼Œå°±æŠŠæŒ‰éˆ•è®Šç°ï¼Œé˜²æ­¢èª¤æŒ‰
        const buttons = document.querySelectorAll('.bet-buttons button');
        if (myProfile.lastBet || myProfile.has_bet_today) {
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
            });
        } else {
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            });
        }
}


        async function placeBet(choice) {
            // A. ç«‹å³é˜»æ–·é€£é» (é˜²æ­¢æŒ‰éˆ•é‡è¤‡è§¸ç™¼)
            if (this.isLoading) return;
            this.isLoading = true;

            try {
                // B. é‡æ–°å¾è³‡æ–™åº«æª¢æŸ¥æœ€æ–°ç‹€æ…‹ (æœ€ä¿éšª)
                const { data: user, error: checkError } = await _db
                    .from('ei-players')
                    .select('balance, has_bet_today')
                    .eq('id', myProfile.id)
                    .single();

                if (checkError) throw new Error("è®€å–ç‹€æ…‹å¤±æ•—");

                if (user.has_bet_today) {
                    alert("ä½ é€™è¼ªå·²ç¶“æŠ•éç¥¨å›‰ï¼è«‹ç­‰ä¸‹ä¸€é¡Œã€‚");
                    return;
                }

                if (user.balance < 100) {
                    alert("ç±Œç¢¼ä¸è¶³ï¼");
                    return;
                }

                // C. åŸ·è¡Œæ‰£æ¬¾èˆ‡é–å®š (é€™ç­†éŒ¢æ˜¯æ ¹æ“šç•¶ä¸‹çš„é¤˜é¡å»æ‰£)
                const newBalance = user.balance - 100;
                const { error: updError } = await _db.from('ei-players')
                    .update({
                        balance: newBalance,
                        has_bet_today: true,
                        last_choice: choice
                    })
                    .eq('id', myProfile.id);

                if (updError) throw updError;

                // D. æ›´æ–°æˆåŠŸå¾ŒåŒæ­¥æœ¬åœ°è®Šæ•¸
                myProfile.balance = newBalance;
                myProfile.lastBet = choice;
                renderUI();

                alert(`ä¸‹æ³¨æˆåŠŸï¼š${choice}ï¼`);
            } catch (err) {
                console.error(err);
                alert("æ“ä½œå¤±æ•—: " + err.message);
            } finally {
                this.isLoading = false; // è§£é™¤é˜»æ–·
            }
        }



        async function send() {
            const input = document.getElementById('msg');
            const content = input.value.trim();
            if (!content) return;

            const { error } = await _db.from('ei-board1').insert([{
                content: content,
                user_id: myProfile.id,
                bet_tag: myProfile.lastBet
            }]);

            if (!error) {
                input.value = '';
                myProfile.lastBet = ''; // ç™¼å®Œæ¸…ç©ºæœ¬æ¬¡ä¸‹æ³¨ç‹€æ…‹
                loadBoard();
            } else {
                alert("ç™¼é€å¤±æ•—");
            }
        }

        async function loadBoard() {
            const { data, error } = await _db.from('ei-board1').select('*').order('created_at', { ascending: false }).limit(20);
            if (error) return;

            const board = document.getElementById('board');
            board.innerHTML = data.map(p => `
            <div class="post">
                ${p.bet_tag ? `<span class="tag ${p.bet_tag === 'çœ‹æ¼²' ? 'tag-up' : 'tag-down'}">${p.bet_tag}</span>` : ''}
                ${escapeHTML(p.content)}
                <small style="display:block; color:#999; margin-top:8px;">${new Date(p.created_at).toLocaleString()}</small>
            </div>
        `).join('');
        }

        async function restoreAccount() {
            const code = prompt("è«‹è¼¸å…¥æ‚¨çš„ 6 ä½å¼•ç¹¼ç¢¼ï¼š");
            if (!code) return;

            const { data, error } = await _db.from('ei-players').select('*').eq('backup_code', code.toUpperCase()).maybeSingle();

            if (error || !data) return alert("æ‰¾ä¸åˆ°æ­¤ä»£ç¢¼ï¼");

            if (confirm(`æ‰¾åˆ°å¸³è™Ÿï¼é¤˜é¡ï¼š${data.balance}ã€‚ç¢ºå®šåˆ‡æ›ï¼Ÿ`)) {
                localStorage.setItem('my_backup_code', data.backup_code);
                location.reload();
            }
        }

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        // å•Ÿå‹•
        init();
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é æ¸¬æ±ºé¬¥ç‹ v3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #333; --bg: #F2F0EB; --accent: #ff9500; }
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--primary); line-height: 1.6; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .user-info { background: #333; color: white; padding: 12px 20px; border-radius: 50px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .bet-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .bet-buttons button { flex: 1; padding: 15px; border-radius: 10px; border: none; color: white; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .bet-buttons button:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }
        textarea { width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 10px; padding: 12px; box-sizing: border-box; resize: none; font-size: 16px; margin-top: 10px; }
        .btn-send { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 10px; margin-top: 10px; cursor: pointer; font-weight: bold; }
        .post { background: white; padding: 15px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tag { font-size: 11px; padding: 4px 10px; border-radius: 6px; margin-right: 8px; font-weight: bold; color: white; }
    </style>
</head>
<body>

    <h2 style="display:flex; justify-content:space-between;">ğŸ”¥ é æ¸¬è¨è«–å€ <span id="status" style="font-size:12px; color:gray;">â— é€£ç·šä¸­</span></h2>

    <div class="card user-info">
        <span>ğŸ’° ç±Œç¢¼: <b id="balance">---</b></span>
        <span>
            <small id="code-display" style="margin-right:10px;">ä»£ç¢¼: ---</small>
            <button onclick="restoreAccount()" style="background:#555; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer;">æ‰¾å›å¸³è™Ÿ</button>
        </span>
    </div>

    <div class="card" style="background: #fffbe6; border: 1px solid #ffe58f;">
       <strong style="color: #856404;">ğŸ† è²¡å¯Œæ’è¡Œæ¦œ (Top 5)</strong>
       <div id="leaderboard" style="margin-top: 10px; font-size: 14px;">
        è¼‰å…¥ä¸­...
       </div>
    </div>




    <div class="card" style="border:2px solid var(--accent);">
        <strong>ã€ä»Šæ—¥é¡Œç›®ã€‘æ˜å¤©å°è‚¡æœƒæ”¶ç´…ç›¤å—ï¼Ÿ</strong>
        <div class="bet-buttons">
            <button id="btn-up" onclick="placeBet('çœ‹æ¼²')" style="background:#e74c3c">æŠ¼ã€Œæ¼²ã€ (100)</button>
            <button id="btn-down" onclick="placeBet('çœ‹è·Œ')" style="background:#27ae60">æŠ¼ã€Œè·Œã€ (100)</button>
        </div>
        <p id="bet-hint" style="font-size:12px; color:#e74c3c; margin-top:10px; display:none;">âš ï¸ æœ¬è¼ªæ‚¨å·²ç¶“æŠ•éç¥¨å›‰ï¼</p>
    </div>

    <div class="card">
        <textarea id="msg" placeholder="èŠèŠä½ çš„çœ‹æ³•..."></textarea>
        <button class="btn-send" onclick="send()">é€å‡ºç•™è¨€</button>
    </div>

    <div id="board">è¼‰å…¥ç•™è¨€ä¸­...</div>

<script>
    const SUPABASE_URL = 'https://bwkwhieercycwlwhuhml.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_t0WbG_SCuMwWMQBDMlsOEg_vtNXV_Fq';
    const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myProfile = { id: null, balance: 0, has_bet_today: false, last_choice: "", backup_code: "" };
    let isBusy = false; // é˜²æ­¢é‡è¤‡é€£é»

    async function init() {
        try {
            const { data: auth, error: aErr } = await _db.auth.signInAnonymously();
            if (aErr) throw aErr;

            const savedCode = localStorage.getItem('my_backup_code');
            let data = null;

            if (savedCode) {
                const res = await _db.from('ei-players').select('*').eq('backup_code', savedCode).maybeSingle();
                data = res.data;
            }
            if (!data) {
                const res = await _db.from('ei-players').select('*').eq('id', auth.user.id).maybeSingle();
                data = res.data;
            }
            if (!data) {
                const newCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const { data: newData, error: iErr } = await _db.from('ei-players')
                    .insert([{ id: auth.user.id, balance: 1000, backup_code: newCode }])
                    .select().single();
                if (iErr) throw iErr;
                data = newData;
            }

            // åŒæ­¥è³‡æ–™
            myProfile.id = data.id;
            myProfile.balance = data.balance;
            myProfile.has_bet_today = data.has_bet_today;
            myProfile.last_choice = data.last_choice;
            myProfile.backup_code = data.backup_code;
            localStorage.setItem('my_backup_code', data.backup_code);

            renderUI();
            loadBoard();
            updateLeaderboard();
            document.getElementById('status').innerText = "â— åœ¨ç·š";
            document.getElementById('status').style.color = "green";
        } catch (err) {
            document.getElementById('status').innerText = "â— é€£ç·šå¤±æ•—: " + err.message;
        }
    }

    function renderUI() {
        document.getElementById('balance').innerText = myProfile.balance;
        document.getElementById('code-display').innerText = "ä»£ç¢¼: " + myProfile.backup_code;
        
        // é–å®šæŒ‰éˆ•é‚è¼¯
        const upBtn = document.getElementById('btn-up');
        const downBtn = document.getElementById('btn-down');
        const hint = document.getElementById('bet-hint');

        if (myProfile.has_bet_today) {
            upBtn.disabled = true;
            downBtn.disabled = true;
            hint.style.display = "block";
            hint.innerText = `âš ï¸ æ‚¨å·²æŠ¼æ³¨ã€Œ${myProfile.last_choice}ã€ï¼Œè«‹ç­‰å¾…é–‹çã€‚`;
        } else {
            upBtn.disabled = false;
            downBtn.disabled = false;
            hint.style.display = "none";
        }
    }





    async function placeBet(choice) {
    if (isBusy) return;
    isBusy = true;

    try {
        // ç›´æ¥å‘¼å«è³‡æ–™åº«å…§éƒ¨çš„å‡½å¼ï¼Œé€™æ¨£æœ€å®‰å…¨ï¼Œä¸æœƒæœ‰å‰ç«¯å›å‚³èˆŠæ•¸å­—çš„å•é¡Œ
        const { error } = await _db.rpc('place_bet_safe', {
            player_uuid: myProfile.id,
            bet_choice: choice
        });

        if (error) throw error;

        // ä¸‹æ³¨å¾Œã€Œå¼·è¿«é‡è®€ã€ä¸€æ¬¡æœ€æ–°çš„è³‡æ–™åº«ç‹€æ…‹
        const { data: latest } = await _db.from('ei-players').select('*').eq('id', myProfile.id).single();
        
        myProfile.balance = latest.balance;
        myProfile.has_bet_today = latest.has_bet_today;
        myProfile.last_choice = latest.last_choice;
        
        renderUI();
        alert("ä¸‹æ³¨æˆåŠŸï¼");
    } catch (err) {
        console.error(err);
        alert("ä¸‹æ³¨å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç±Œç¢¼ä¸è¶³æˆ–é‡è¤‡ä¸‹æ³¨");
    } finally {
        isBusy = false;
    }
}





    async function send() {
        const input = document.getElementById('msg');
        if (!input.value.trim() || isBusy) return;
        
        isBusy = true;
        const { error } = await _db.from('ei-board1').insert([{
            content: input.value,
            user_id: myProfile.id,
            bet_tag: myProfile.has_bet_today ? myProfile.last_choice : ""
        }]);

        if (!error) {
            input.value = '';
            loadBoard();
        }
        isBusy = false;
    }

    async function loadBoard() {
        const { data } = await _db.from('ei-board1').select('*').order('created_at', { ascending: false }).limit(20);
        if (!data) return;
        document.getElementById('board').innerHTML = data.map(p => `
            <div class="post">
                ${p.bet_tag ? `<span class="tag ${p.bet_tag==='çœ‹æ¼²'?'tag-up':'tag-down'}" style="background:${p.bet_tag==='çœ‹æ¼²'?'#e74c3c':'#27ae60'}">${p.bet_tag}</span>` : ''}
                ${p.content}
                <small style="display:block; color:#999; margin-top:8px;">${new Date(p.created_at).toLocaleString()}</small>
            </div>
        `).join('');
         updateLeaderboard();
    }

    async function restoreAccount() {
        const code = prompt("è¼¸å…¥ 6 ä½å¼•ç¹¼ç¢¼ï¼š");
        if (!code) return;
        const { data } = await _db.from('ei-players').select('*').eq('backup_code', code.toUpperCase()).maybeSingle();
        if (data && confirm(`æ‰¾åˆ°å¸³è™Ÿï¼Œé¤˜é¡ ${data.balance}ï¼Œç¢ºå®šåˆ‡æ›ï¼Ÿ`)) {
            localStorage.setItem('my_backup_code', data.backup_code);
            location.reload();
        } else {
            alert("æ‰¾ä¸åˆ°è©²å¸³è™Ÿ");
        }
    }

    init();

async function updateLeaderboard() {
    try {
        // å¾ ei-players æŠ“å–é¤˜é¡æœ€é«˜çš„å‰ 5 å
        const { data, error } = await _db
            .from('ei-players')
            .select('balance, backup_code')
            .order('balance', { ascending: false })
            .limit(5);

        if (error) throw error;

        const listEl = document.getElementById('leaderboard');
        if (data.length === 0) {
            listEl.innerHTML = "ç›®å‰å°šç„¡è³‡æ–™";
            return;
        }

        // æ¸²æŸ“æ’è¡Œæ¦œï¼Œä¸¦å°‡ä»£ç¢¼é®ç½©è™•ç† (ä¾‹å¦‚ ABCDEF -> ABC***)
        listEl.innerHTML = data.map((user, index) => {
            const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4.', '5.'][index];
            const maskedCode = user.backup_code ? user.backup_code.substring(0, 3) + "***" : "åŒ¿åç©å®¶";
            return `
                <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #eee;">
                    <span>${medal} ç©å®¶ ${maskedCode}</span>
                    <strong style="color: #d48806;">$${user.balance}</strong>
                </div>
            `;
        }).join('');
    } catch (err) {
        console.error("æ’è¡Œæ¦œæ›´æ–°å¤±æ•—:", err);
    }
}


</script>
</body>
</html>